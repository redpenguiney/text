<!DOCTYPE html>
<html>

<head>
<title>Text</title>
<style>
    h1 {color:whitesmoke}
    body {background-color:rgb(69, 79, 172)}
    div {background-color: rgb(70, 68, 116)}
    p {color: whitesmoke}
</style>
</head>

<body>

    <h1>TEXT: THE GAME</h1>
    <p>Hi there!</p>

    <div>
        <p id = "words"></p>

        <form id = "choice">
            <input type="text" Input your selected action:>
        </form>
        
    </div>

    <script>
        class Action {
            constructor() {
                this.execute = function(ctx) {}
                this.get_description = function() { return "DEFAULT_ACTION_DESC"}
                this.sort_category = 0
                this.key = "AUTO"
                this.undoable = true
                this.incrementTurnid = true
            }
        }

        class Room {
            constructor() {
                this.name = "DEFAULT_ROOM_NAME"
                this.get_available_actions = function() { return []}
                this.get_description = function() {return "Something about this room feels... incomplete.<br>"}
            }
        }

        // city centre, shopping centre, apartments,  

        cityCentreRoom = new Room()

        settingsAction = new Action()
        settingsAction.get_description = function(ctx) { return "Open settings"}
        settingsAction.key = "s"
        settingsAction.execute = function(ctx) { ctx.log += "settings have opened<br>"}
        // settingsAction.undoable = false
        backInHistoryAction = new Action()
        backInHistoryAction.get_description = function(ctx) { return "Wait, run it back"}
        backInHistoryAction.key = "U"
        backInHistoryAction.undoable = false // can't undo your undos lol
        backInHistoryAction.incrementTurnid = false

        

        class Context {
            constructor() {
                this.log = "\t<i>\"Two minutes to arrival at Pentyne Station,\"</i> the train systems chirp. <i>\"If this is your stop, please prepare to disembark with all of your belongings</i>\".<br><br>"
                +"\tBefore putting the mission file back in your briefcase, you give it one last cursory glance:<br><br>"
                +"<center>INQUIRY NO. 403861<br>RESTRICTED ACCESS: MAY CONTAIN INFORMATION PERTINENT TO NATIONAL SECURITY<br>DO NOT TRANSFER TO UNAUTHORIZED PARTIES<br><br></center>"
                +"Dear agent,<br><br>\tThe Internal Economics Council has asked the Party Investigation Division to take a look at certain anomalous economic data in the city of Burger (pop. 1782718). "
                +"Analytics suspects extremely high levels of graft as the primary cause, possibly with some level of dealing with the Nugynt insurgency.<br><br>"
                +"\tYour job is to confirm or deny this theory and, more broadly speaking, evalute the general situation in Burger and suggest corrective measures. "
                +"Given the military and cultural significance of Burger to the Nation, this task has been deemed Priority Two. You are expected to provide weekly reports with your first report to be sent the Friday after today. "
                +"As per PID & 52.a.3, should you need additional material to complete this mission, request it immediately. "
                +"The remainder of this report is a brief summary of the relevant economic data as well as various information considered relevant to your investigation."
                +"<br><br>"
                +"The report streches on for some fifty pages after that. You get up as the train comes to a stop. "
                +"Five minutes later, you are standing outside Burger station. <br><br>"
                +"What do you do?"
                +"<br><br>"
                
                this.currentRoom = new Room()

                this.previous = null

                this.turnId = 0

                this.time = 0 // in seconds
            }

            get_available_actions() {
                let actions = this.currentRoom.get_available_actions()

                actions.push(settingsAction)
                if (this.previous) {
                    actions.push(backInHistoryAction)
                }

                return actions
            }
        }

        let ctx = new Context()
        
        function describe_situation() {
            ctx.log += ctx.currentRoom.get_description();

            let actions = ctx.get_available_actions()
            let actionStrings = []
            let i = 1
            for (let action in actions) {
                let key = actions[action].key
                if (key == "AUTO") {
                    key = i++
                }
                actionStrings.push("["+key+"]"+" "+actions[action].get_description(ctx))
            }
            for (s in actionStrings) {
                ctx.log += actionStrings[s] + "<br>"
            }

            
            ctx.log += "<br>id = " + ctx.turnId + "<br>"
            
            ctx.log += "<br>"
        }
        
        backInHistoryAction.execute = function(_) {
            alert(ctx.turnId)
            ctx = ctx.previous
            ctx.log += "After careful consideration, you decided doing that would have been dumb.<br><br>"
            alert(ctx.turnId)
        }

        const choices = document.getElementById("choice")
        const log = document.getElementById("words") 

        function refresh_text() {
            choices[0].value = "" 
            log.innerHTML = "<p>"+ctx.log+"</p>"
        }

        function on_input(event) {
            if (event && choices[0].value != "") {
                ctx.log += "&gt" + choices[0].value + "<br>"
                let selected = null

                let actions = ctx.get_available_actions()
                let i = 1
                for (action in actions) {
                    let key = actions[action].key
                    if (key == "AUTO") {
                        key = i++
                    }
                    if (key == choices[0].value) {
                        selected = actions[action]
                        break
                    }
                }

                if (selected) {
                    if (selected.undoable) {
                        function good_copy(obj) { // bruh no copying functions with std stuff
                            let out = new Context()
                            for (key in obj) {
                                if (typeof(obj[key]) == "object") {
                                    out[key] = good_copy(obj[key])
                                }
                                else {
                                    out[key] = obj[key]
                                }
                            }
                            return out
                        }

                        backup = good_copy(ctx)
                        ctx.previous = backup
                    }
                    selected.execute(ctx)
                    if (selected.incrementTurnid) { 
                        ctx.turnId++
                        describe_situation(ctx)
                    }
                }
                else {
                    ctx.log += "Invalid input, please try again.<br><br><i>To select most choices, simply enter the character(s) denoted within [].</i><br><br>"
                }
                
            }

            if (event) {
                event.preventDefault();
            }

            refresh_text();
        }
        choices.addEventListener("submit", on_input)
        describe_situation();
        refresh_text();
       
    </script>
    <noscript><p>No JavaScript support?<br>You leave this place, never to return. Pathetic wretch.</p></noscript>

</body>
</html>

